{% extends "base.html" %}
{% block title %}NPC Manager - Warhammer Fantasy{% endblock %}

{% block content %}
<style>
.main {
    background: transparent !important;
    box-shadow: none !important;
    width: 100% !important;
    max-width: none !important;
    position: static !important;
    z-index: auto !important;
}
body {
    overflow-x: hidden;
}
.floating-image {
    position: fixed !important;
    z-index: -10 !important;
    pointer-events: none !important;
    filter: blur(10px) !important;
}
.overlay2 {
    position: fixed !important;
    z-index: -9 !important;
    pointer-events: none !important;
    background-color: rgba(35, 45, 40, 0.7) !important;
}
.npc-container,
.npc-header,
.npc-grid,
.npc-card {
    z-index: 1 !important;
    position: relative !important;
}
/* Upewnij się że menu i sidebar są nad kartami */
.user-menu {
    z-index: 10000 !important;
}
.roller-sidebar {
    z-index: 10001 !important;
}
.roller-toggle {
    z-index: 10002 !important;
}
</style>
<script>
// Wyłącz animację tła na tej stronie
document.addEventListener('DOMContentLoaded', function() {
    const img = document.getElementById('img');
    if (img) {
        img.style.animation = 'none';
    }
});
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='style2.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='npc_cards.css') }}">

<div class="floating-image" id="img" style="background-image: url('{{ url_for('static', filename='back.jpg') }}');"></div>
<div class="overlay2"></div>

<div class="npc-container">
    <div class="npc-header">
        <h1>⚔️ Bohaterowie Niezależni - Warhammer Fantasy</h1>
        <div class="npc-actions">
            <button onclick="createNewNPC()" class="btn btn-save">+ Dodaj Nowego NPC</button>
            <a href="{{ url_for('npc_manager') }}" class="btn btn-cancel">← Powrót</a>
        </div>
    </div>

    <div class="npc-grid" id="npcGrid">
        {% for npc in npcs %}
        <div class="npc-card warhammer-card" data-npc-id="{{ npc.id }}">
            <div class="npc-card-header">
                <input type="text" class="npc-name" value="{{ npc.imie }}"
                       onblur="updateNPC({{ npc.id }}, 'imie', this.value)" placeholder="Imię NPC">
                <button class="delete-npc-btn" onclick="deleteNPC({{ npc.id }})" title="Usuń NPC">×</button>
            </div>

            <div class="npc-card-body">
                <div class="npc-field">
                    <label>Profesja:</label>
                    <input type="text" value="{{ npc.profesja or '' }}"
                           onblur="updateNPC({{ npc.id }}, 'profesja', this.value)" placeholder="Profesja">
                </div>

                <div class="npc-stats-grid">
                    <div class="stat-item">
                        <label>WW</label>
                        <input type="number" value="{{ npc.walka_wrecz }}"
                               onblur="updateNPC({{ npc.id }}, 'walka_wrecz', this.value)">
                    </div>
                    <div class="stat-item">
                        <label>US</label>
                        <input type="number" value="{{ npc.umiejetnosci_strzeleckie }}"
                               onblur="updateNPC({{ npc.id }}, 'umiejetnosci_strzeleckie', this.value)">
                    </div>
                    <div class="stat-item">
                        <label>K</label>
                        <input type="number" value="{{ npc.krzepa }}"
                               onblur="updateNPC({{ npc.id }}, 'krzepa', this.value)">
                    </div>
                    <div class="stat-item">
                        <label>Odp</label>
                        <input type="number" value="{{ npc.odpornosc }}"
                               onblur="updateNPC({{ npc.id }}, 'odpornosc', this.value)">
                    </div>
                    <div class="stat-item">
                        <label>Zr</label>
                        <input type="number" value="{{ npc.zrecznosc }}"
                               onblur="updateNPC({{ npc.id }}, 'zrecznosc', this.value)">
                    </div>
                    <div class="stat-item">
                        <label>Int</label>
                        <input type="number" value="{{ npc.inteligencja }}"
                               onblur="updateNPC({{ npc.id }}, 'inteligencja', this.value)">
                    </div>
                    <div class="stat-item">
                        <label>SW</label>
                        <input type="number" value="{{ npc.sila_woli }}"
                               onblur="updateNPC({{ npc.id }}, 'sila_woli', this.value)">
                    </div>
                    <div class="stat-item">
                        <label>Ogd</label>
                        <input type="number" value="{{ npc.oglada }}"
                               onblur="updateNPC({{ npc.id }}, 'oglada', this.value)">
                    </div>
                </div>

                <div class="npc-points">
                    <div class="point-item">
                        <label>PŻ</label>
                        <input type="number" value="{{ npc.punkty_zycia }}"
                               onblur="updateNPC({{ npc.id }}, 'punkty_zycia', this.value)">
                    </div>
                    <div class="point-item">
                        <label>Szczęście</label>
                        <input type="number" value="{{ npc.punkty_szczescia }}"
                               onblur="updateNPC({{ npc.id }}, 'punkty_szczescia', this.value)">
                    </div>
                    <div class="point-item">
                        <label>Pancerz</label>
                        <input type="number" value="{{ npc.pancerz }}"
                               onblur="updateNPC({{ npc.id }}, 'pancerz', this.value)">
                    </div>
                    <div class="point-item">
                        <label>Szybkość</label>
                        <input type="number" value="{{ npc.szybkosc }}"
                               onblur="updateNPC({{ npc.id }}, 'szybkosc', this.value)">
                    </div>
                </div>

                <div class="npc-skills-section">
                    <h4>Kluczowe Umiejętności</h4>
                    {% for i in range(1, 7) %}
                    <div class="skill-row">
                        <input type="text" placeholder="Nazwa" class="skill-name-input"
                               value="{{ npc['skill_' ~ i ~ '_name'] or '' }}"
                               onblur="updateNPC({{ npc.id }}, 'skill_{{ i }}_name', this.value)">
                        <input type="number" placeholder="0" class="skill-value-input"
                               value="{{ npc['skill_' ~ i ~ '_value'] or 0 }}"
                               onblur="updateNPC({{ npc.id }}, 'skill_{{ i }}_value', this.value)">
                    </div>
                    {% endfor %}
                </div>

                <div class="npc-notes">
                    <label>Notatki:</label>
                    <textarea rows="4" placeholder="Notatki o postaci..."
                              onblur="updateNPC({{ npc.id }}, 'notatki', this.value)">{{ npc.notatki or '' }}</textarea>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function createNewNPC() {
    fetch("{{ url_for('npc_manager_warhammer') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'action=create&imie=Nowy NPC'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function updateNPC(npcId, field, value) {
    const formData = new FormData();
    formData.append('action', 'update');
    formData.append('npc_id', npcId);
    formData.append(field, value);

    fetch("{{ url_for('npc_manager_warhammer') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Błąd podczas zapisywania!');
        }
    });
}

function deleteNPC(npcId) {
    if (!confirm('Czy na pewno chcesz usunąć tego NPC?')) return;

    const formData = new FormData();
    formData.append('action', 'delete');
    formData.append('npc_id', npcId);

    fetch("{{ url_for('npc_manager_warhammer') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}
</script>

<script src="{{ url_for('static', filename='main.js') }}"></script>
{% endblock %}
