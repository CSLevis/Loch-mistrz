{% extends "base.html" %}
{% block title %}NPC Manager - Warhammer Fantasy{% endblock %}

{% block content %}
<style>
    .main {
        background: transparent !important;
        box-shadow: none !important;
        width: 100% !important;
        max-width: none !important;
        position: static !important;
        z-index: auto !important;
    }

    body {
        overflow-x: hidden;
    }

    .floating-image {
        position: fixed !important;
        z-index: -10 !important;
        pointer-events: none !important;
        filter: blur(10px) !important;
    }

    .overlay2 {
        position: fixed !important;
        z-index: -9 !important;
        pointer-events: none !important;
        background-color: rgba(35, 45, 40, 0.7) !important;
    }

    .npc-container,
    .npc-header,
    .npc-grid,
    .npc-card {
        z-index: 1 !important;
        position: relative !important;
    }

    /* Upewnij się że menu i sidebar są nad kartami */
    .user-menu {
        z-index: 10000 !important;
    }

    .roller-sidebar {
        z-index: 10001 !important;
    }

    .roller-toggle {
        z-index: 10002 !important;
    }
</style>
<script>
    // Wyłącz animację tła na tej stronie
    document.addEventListener('DOMContentLoaded', function () {
        const img = document.getElementById('img');
        if (img) {
            img.style.animation = 'none';
        }
    });
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='style2.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='npc_cards.css') }}">

<div class="floating-image" id="img" style="background-image: url('{{ url_for('static', filename='back.jpg') }}');">
</div>
<div class="overlay2"></div>

<div class="npc-container">
    <div class="npc-header">
        <h1>⚔️ {{ _('npc_manager_title') }} - Warhammer Fantasy</h1>
        <div class="npc-actions">
            <button onclick="createNewNPC()" class="btn btn-save">{{ _('npc_add_new') }}</button>
            <a href="{{ url_for('npc_manager') }}" class="btn btn-cancel">← {{ _('nav_back') }}</a>
        </div>
    </div>

    <div class="npc-grid" id="npcGrid">
        {% for npc in npcs %}
        <div class="npc-card warhammer-card" data-npc-id="{{ npc.id }}">
            <div class="npc-card-header">
                <input type="text" class="npc-name" value="{{ npc.imie }}"
                    onblur="updateNPC({{ npc.id }}, 'imie', this.value)" placeholder="{{ _('npc_placeholder_name') }}">
                <button class="delete-npc-btn" onclick="deleteNPC({{ npc.id }})" title="Usuń NPC">×</button>
            </div>

            <div class="npc-card-body">
                <div class="npc-field">
                    <label>{{ _('npc_profession') }}</label>
                    <input type="text" value="{{ npc.profesja or '' }}"
                        onblur="updateNPC({{ npc.id }}, 'profesja', this.value)"
                        placeholder="{{ _('npc_profession')[:-1] }}">
                </div>

                <div class="npc-stats-grid">
                    <div class="npc-stats-grid">
                        <div class="stat-item">
                            <label>{{ _('stat_ww') }}</label>
                            <input type="number" value="{{ npc.walka_wrecz }}"
                                onblur="updateNPC({{ npc.id }}, 'walka_wrecz', this.value)">
                        </div>
                        <div class="stat-item">
                            <label>{{ _('stat_us') }}</label>
                            <input type="number" value="{{ npc.umiejetnosci_strzeleckie }}"
                                onblur="updateNPC({{ npc.id }}, 'umiejetnosci_strzeleckie', this.value)">
                        </div>
                        <div class="stat-item">
                            <label>{{ _('stat_k') }}</label>
                            <input type="number" value="{{ npc.krzepa }}"
                                onblur="updateNPC({{ npc.id }}, 'krzepa', this.value)">
                        </div>
                        <div class="stat-item">
                            <label>{{ _('stat_odp') }}</label>
                            <input type="number" value="{{ npc.odpornosc }}"
                                onblur="updateNPC({{ npc.id }}, 'odpornosc', this.value)">
                        </div>
                        <div class="stat-item">
                            <label>{{ _('stat_zr') }}</label>
                            <input type="number" value="{{ npc.zrecznosc }}"
                                onblur="updateNPC({{ npc.id }}, 'zrecznosc', this.value)">
                        </div>
                        <div class="stat-item">
                            <label>{{ _('stat_int') }}</label>
                            <input type="number" value="{{ npc.inteligencja }}"
                                onblur="updateNPC({{ npc.id }}, 'inteligencja', this.value)">
                        </div>
                        <div class="stat-item">
                            <label>{{ _('stat_sw') }}</label>
                            <input type="number" value="{{ npc.sila_woli }}"
                                onblur="updateNPC({{ npc.id }}, 'sila_woli', this.value)">
                        </div>
                        <div class="stat-item">
                            <label>{{ _('stat_ogd') }}</label>
                            <input type="number" value="{{ npc.oglada }}"
                                onblur="updateNPC({{ npc.id }}, 'oglada', this.value)">
                        </div>
                    </div>

                    <div class="npc-points">
                        <div class="point-item">
                            <label>{{ _('stat_pz') }}</label>
                            <input type="number" value="{{ npc.punkty_zycia }}"
                                onblur="updateNPC({{ npc.id }}, 'punkty_zycia', this.value)">
                        </div>
                        <div class="point-item">
                            <label>{{ _('stat_luck') }}</label>
                            <input type="number" value="{{ npc.punkty_szczescia }}"
                                onblur="updateNPC({{ npc.id }}, 'punkty_szczescia', this.value)">
                        </div>
                        <div class="point-item">
                            <label>{{ _('stat_armor') }}</label>
                            <input type="number" value="{{ npc.pancerz }}"
                                onblur="updateNPC({{ npc.id }}, 'pancerz', this.value)">
                        </div>
                        <div class="point-item">
                            <label>{{ _('stat_speed') }}</label>
                            <input type="number" value="{{ npc.szybkosc }}"
                                onblur="updateNPC({{ npc.id }}, 'szybkosc', this.value)">
                        </div>
                    </div>

                    <div class="npc-skills-section">
                        <h4>{{ _('npc_skills_key') }}</h4>
                        {% for i in range(1, 7) %}
                        <div class="skill-row">
                            <input type="text" placeholder="{{ _('npc_placeholder_skill') }}" class="skill-name-input"
                                value="{{ npc['skill_' ~ i ~ '_name'] or '' }}"
                                onblur="updateNPC({{ npc.id }}, 'skill_{{ i }}_name', this.value)">
                            <input type="number" placeholder="0" class="skill-value-input"
                                value="{{ npc['skill_' ~ i ~ '_value'] or 0 }}"
                                onblur="updateNPC({{ npc.id }}, 'skill_{{ i }}_value', this.value)">
                        </div>
                        {% endfor %}
                    </div>

                    <div class="npc-notes">
                        <label>{{ _('npc_notes') }}</label>
                        <textarea rows="4" placeholder="{{ _('npc_notes_placeholder') }}"
                            onblur="updateNPC({{ npc.id }}, 'notatki', this.value)">{{ npc.notatki or '' }}</textarea>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        function createNewNPC() {
            fetch("{{ url_for('npc_manager_warhammer') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'action=create&imie=Nowy NPC'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
        }

        function updateNPC(npcId, field, value) {
            const formData = new FormData();
            formData.append('action', 'update');
            formData.append('npc_id', npcId);
            formData.append(field, value);

            fetch("{{ url_for('npc_manager_warhammer') }}", {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert("{{ _('error_saving') }}");
                    }
                });
        }

        function deleteNPC(npcId) {
            if (!confirm("{{ _('npc_delete_confirm') }}")) return;

            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('npc_id', npcId);

            fetch("{{ url_for('npc_manager_warhammer') }}", {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
        }
    </script>

    <script src="{{ url_for('static', filename='main.js') }}"></script>
    {% endblock %}