<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <title>{% block title %}{% endblock %}</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- PWA Settings -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='d20a.png') }}">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("{{ url_for('static', filename='sw.js') }}");
            });
        }
    </script>
    <!-- HTMX for Gapless Navigation -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>

<body hx-boost="true">
    <!-- Menu powrotu - tylko jeÅ›li NIE jesteÅ› na stronie gÅ‚Ã³wnej -->
    {% if request.endpoint != 'index' %}
    <div class="user-menu" style="left: 20px; right: auto;">
        <a href="{{ url_for('index') }}">{{ _('nav_back') }}</a>
    </div>
    {% endif %}

    <!-- Menu logowania -->
    <div class="user-menu">
        {% if current_user.is_authenticated %}
        <span class="username">{{ current_user.username }}</span>
        <a href="{{ url_for('logout') }}">{{ _('logout') }}</a>
        {% else %}
        <a href="{{ url_for('login') }}">{{ _('login') }}</a>
        <a href="{{ url_for('register') }}">{{ _('register') }}</a>
        {% endif %}
    </div>

    <!-- Komunikaty flash -->
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="flash-messages">
        {% for message in messages %}
        <div class="flash-message">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <header>

    </header>

    <main>
        <div class="main">

            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- MUZYKA - rÃ³Å¼na dla kaÅ¼dego systemu -->
    <script>
        // Globalny obiekt audio zainicjalizowany raz
        if (!window.audioContext) {
            window.audioContext = {
                instance: null,
                currentFile: null
            };
        }

        function initMusic() {
            const currentPath = window.location.pathname;
            let musicFile = '/static/tÅ‚o.mp3';

            if (currentPath.includes('cthulhu')) {
                musicFile = '/static/tÅ‚o4.mp3';
            } else if (currentPath.includes('dnd5e')) {
                musicFile = '/static/tÅ‚o.mp3';
            } else if (currentPath.includes('warhammer')) {
                musicFile = '/static/tÅ‚o2.mp3';
            }

            // Inicjalizacja lub zmiana utworu
            if (!window.audioContext.instance) {
                window.audioContext.instance = new Audio(musicFile);
                window.audioContext.instance.loop = true;
                window.audioContext.instance.volume = 0.3;
                window.audioContext.currentFile = musicFile;

                const savedTime = sessionStorage.getItem('musicTime');
                if (savedTime && sessionStorage.getItem('lastMusicFile') === musicFile) {
                    window.audioContext.instance.currentTime = parseFloat(savedTime);
                }
            } else if (window.audioContext.currentFile !== musicFile) {
                window.audioContext.instance.pause();
                window.audioContext.instance.src = musicFile;
                window.audioContext.currentFile = musicFile;
                window.audioContext.instance.currentTime = 0;
                if (sessionStorage.getItem('musicStarted') === 'true') {
                    window.audioContext.instance.play().catch(e => console.log('Transition blocked'));
                }
            }

            sessionStorage.setItem('lastMusicFile', musicFile);
            updateMusicUI();
        }

        function updateMusicUI() {
            const toggle = document.getElementById('musicToggle');
            if (!toggle || !window.audioContext.instance) return;
            const isMuted = localStorage.getItem('musicMuted') === 'true';
            toggle.innerHTML = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
            window.audioContext.instance.muted = isMuted;
        }

        function toggleMusic(event) {
            if (event) event.stopPropagation();
            const isMuted = localStorage.getItem('musicMuted') === 'true';
            localStorage.setItem('musicMuted', !isMuted);
            updateMusicUI();

            if (isMuted && window.audioContext.instance) {
                window.audioContext.instance.play().catch(e => console.log('Manual play blocked'));
                sessionStorage.setItem('musicStarted', 'true');
            }
        }

        // Zapisywanie czasu co 200ms dla precyzji
        setInterval(() => {
            if (window.audioContext.instance && !window.audioContext.instance.paused) {
                sessionStorage.setItem('musicTime', window.audioContext.instance.currentTime);
            }
        }, 200);

        // Start/Kontynuacja
        initMusic();
        if (sessionStorage.getItem('musicStarted') === 'true' && localStorage.getItem('musicMuted') !== 'true') {
            window.audioContext.instance.play().catch(e => console.log('Autoplay blocked'));
        }

        // ObsÅ‚uga HTMX (inicjalizacja po zmianie treÅ›ci bez przeÅ‚adowania)
        document.body.addEventListener('htmx:afterOnLoad', () => {
            initMusic();
        });

        // ObsÅ‚uga pierwszego klikniÄ™cia
        document.addEventListener('click', () => {
            if (sessionStorage.getItem('musicStarted') !== 'true' && localStorage.getItem('musicMuted') !== 'true') {
                window.audioContext.instance.play().then(() => {
                    sessionStorage.setItem('musicStarted', 'true');
                });
            }
        }, { once: true });
    </script>
    <!-- DICE ROLLER SIDEBAR -->
    <div class="roller-sidebar" id="rollerSidebar">
        <button class="sidebar-close" onclick="toggleRoller()">âœ•</button>
        {% if 'cthulhu' in request.path %}
        <iframe src="{{ url_for('roller_embedded_cthulhu') }}" class="roller-iframe"></iframe>
        {% else %}
        <iframe src="{{ url_for('roller_embedded') }}" class="roller-iframe"></iframe>
        {% endif %}
    </div>

    <!-- PRZYCISKI DOLNE -->
    <div style="position: fixed; left: 20px; bottom: 20px; display: flex; gap: 10px; z-index: 9998;">
        <button class="music-toggle" id="musicToggle" onclick="toggleMusic(event)"
            title="{{ _('music_on_off') }}">ðŸ”Š</button>
        <button class="roller-toggle" onclick="toggleRoller()" style="position: static;">{{ _('dice_roller_btn')
            }}</button>
    </div>

    <!-- LANGUAGE SWITCHER -->
    <div style="position: fixed; right: 20px; bottom: 20px; display: flex; gap: 5px; z-index: 9999;">
        <a href="{{ url_for('set_language', lang='pl') }}"
            style="text-decoration: none; padding: 5px 10px; background: {{ 'goldenrod' if session.get('lang', 'pl') == 'pl' else 'rgba(0,0,0,0.5)' }}; color: white; border-radius: 4px; border: 1px solid #FFD700; font-weight: bold; font-size: 14px;"
            hx-boost="false">PL</a>
        <a href="{{ url_for('set_language', lang='en') }}"
            style="text-decoration: none; padding: 5px 10px; background: {{ 'goldenrod' if session.get('lang') == 'en' else 'rgba(0,0,0,0.5)' }}; color: white; border-radius: 4px; border: 1px solid #FFD700; font-weight: bold; font-size: 14px;"
            hx-boost="false">EN</a>
    </div>
</body>

</html>