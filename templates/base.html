<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <title>{% block title %}{% endblock %}</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- PWA Settings -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='d20a.png') }}">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("{{ url_for('static', filename='sw.js') }}");
            });
        }
    </script>
</head>

<body>
    <!-- Menu powrotu - tylko jeÅ›li NIE jesteÅ› na stronie gÅ‚Ã³wnej -->
    {% if request.endpoint != 'index' %}
    <div class="user-menu" style="left: 20px; right: auto;">
        <a href="{{ url_for('index') }}">â† PowrÃ³t do menu</a>
    </div>
    {% endif %}

    <!-- Menu logowania -->
    <div class="user-menu">
        {% if current_user.is_authenticated %}
        <span class="username">{{ current_user.username }}</span>
        <a href="{{ url_for('logout') }}">Wyloguj</a>
        {% else %}
        <a href="{{ url_for('login') }}">Zaloguj siÄ™</a>
        <a href="{{ url_for('register') }}">Rejestracja</a>
        {% endif %}
    </div>

    <!-- Komunikaty flash -->
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="flash-messages">
        {% for message in messages %}
        <div class="flash-message">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <header>

    </header>

    <main>
        <div class="main">

            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- MUZYKA - rÃ³Å¼na dla kaÅ¼dego systemu -->
    <script>
        const currentPath = window.location.pathname;
        let musicFile = '/static/tÅ‚o.mp3';

        if (currentPath.includes('cthulhu')) {
            musicFile = '/static/tÅ‚o4.mp3';
        } else if (currentPath.includes('dnd5e')) {
            musicFile = '/static/tÅ‚o.mp3';
        } else if (currentPath.includes('warhammer')) {
            musicFile = '/static/tÅ‚o2.mp3';
        }

        const bgMusic = new Audio(musicFile);
        bgMusic.loop = true;
        bgMusic.volume = 0.3;

        // Persystencja czasu
        const savedFile = sessionStorage.getItem('lastMusicFile');
        const savedTime = sessionStorage.getItem('musicTime');

        if (savedFile === musicFile && savedTime) {
            bgMusic.currentTime = parseFloat(savedTime);
        }
        sessionStorage.setItem('lastMusicFile', musicFile);

        // Zapisuj czas co sekundÄ™
        setInterval(() => {
            if (!bgMusic.paused) {
                // ZaokrÄ…glamy, aby uniknÄ…Ä‡ problemÃ³w z precyzjÄ…
                sessionStorage.setItem('musicTime', bgMusic.currentTime);
            }
        }, 1000);

        function updateMusicUI() {
            const toggle = document.getElementById('musicToggle');
            if (!toggle) return;
            const isMuted = localStorage.getItem('musicMuted') === 'true';
            toggle.innerHTML = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            bgMusic.muted = isMuted;
        }

        function toggleMusic(event) {
            if (event) event.stopPropagation();
            const isMuted = localStorage.getItem('musicMuted') === 'true';
            const newState = !isMuted;
            localStorage.setItem('musicMuted', newState);
            updateMusicUI();

            if (!newState) {
                bgMusic.play().catch(err => console.log('Muzyka zablokowana'));
                sessionStorage.setItem('musicStarted', 'true');
            }
        }

        const musicShouldPlay = sessionStorage.getItem('musicStarted') === 'true' && localStorage.getItem('musicMuted') !== 'true';
        if (musicShouldPlay) {
            bgMusic.play().catch(err => console.log('Autoplay blocked'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateMusicUI();
            if (sessionStorage.getItem('musicStarted') !== 'true') {
                document.body.addEventListener('click', () => {
                    if (localStorage.getItem('musicMuted') !== 'true') {
                        bgMusic.play().then(() => {
                            sessionStorage.setItem('musicStarted', 'true');
                        }).catch(err => console.log('Blocked'));
                    }
                }, { once: true });
            }
        });
    </script>
    <!-- DICE ROLLER SIDEBAR -->
    <div class="roller-sidebar" id="rollerSidebar">
        <button class="sidebar-close" onclick="toggleRoller()">âœ•</button>
        {% if 'cthulhu' in request.path %}
        <iframe src="{{ url_for('roller_embedded_cthulhu') }}" class="roller-iframe"></iframe>
        {% else %}
        <iframe src="{{ url_for('roller_embedded') }}" class="roller-iframe"></iframe>
        {% endif %}
    </div>

    <!-- PRZYCISKI DOLNE -->
    <div style="position: fixed; left: 20px; bottom: 20px; display: flex; gap: 10px; z-index: 9998;">
        <button class="music-toggle" id="musicToggle" onclick="toggleMusic(event)"
            title="WÅ‚Ä…cz/WyÅ‚Ä…cz muzykÄ™">ğŸ”Š</button>
        <button class="roller-toggle" onclick="toggleRoller()" style="position: static;">ğŸ² Roller</button>
    </div>
</body>

</html>