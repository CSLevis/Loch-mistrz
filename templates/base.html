<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <title>{% block title %}{% endblock %}</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- PWA Settings -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='d20a.png') }}">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("{{ url_for('static', filename='sw.js') }}");
            });
        }
    </script>
</head>

<body>
    <!-- Menu powrotu - tylko jeÅ›li NIE jesteÅ› na stronie gÅ‚Ã³wnej -->
    {% if request.endpoint != 'index' %}
    <div class="user-menu" style="left: 20px; right: auto;">
        <a href="{{ url_for('index') }}">â† PowrÃ³t do menu</a>
    </div>
    {% endif %}

    <!-- Menu logowania -->
    <div class="user-menu">
        {% if current_user.is_authenticated %}
        <span class="username">{{ current_user.username }}</span>
        <a href="{{ url_for('logout') }}">Wyloguj</a>
        {% else %}
        <a href="{{ url_for('login') }}">Zaloguj siÄ™</a>
        <a href="{{ url_for('register') }}">Rejestracja</a>
        {% endif %}
    </div>

    <!-- Komunikaty flash -->
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="flash-messages">
        {% for message in messages %}
        <div class="flash-message">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <header>

    </header>

    <main>
        <div class="main">

            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- MUZYKA - rÃ³Å¼na dla kaÅ¼dego systemu -->
    <script>
        // SprawdÅº ktÃ³ry szablon jest aktywny na podstawie URL
        const currentPath = window.location.pathname;
        let musicFile = '/static/tÅ‚o.mp3'; // domyÅ›lna muzyka

        // Wybierz muzykÄ™ w zaleÅ¼noÅ›ci od strony
        if (currentPath.includes('cthulhu')) {
            musicFile = '/static/tÅ‚o4.mp3';
        } else if (currentPath.includes('dnd5e')) {
            musicFile = '/static/tÅ‚o.mp3';
        } else if (currentPath.includes('warhammer')) {
            musicFile = '/static/tÅ‚o2.mp3';
        }

        // Globalny obiekt audio (jeden dla caÅ‚ej sesji)
        if (!window.bgMusicInstance || window.bgMusicInstance.src !== window.location.origin + musicFile) {
            // Zatrzymaj starÄ… muzykÄ™ jeÅ›li gra
            if (window.bgMusicInstance) {
                window.bgMusicInstance.pause();
            }

            window.bgMusicInstance = new Audio(musicFile);
            window.bgMusicInstance.loop = true;
            window.bgMusicInstance.volume = 0.3;
        }

        const bgMusic = window.bgMusicInstance;

        // SprawdÅº czy muzyka juÅ¼ gra
        if (sessionStorage.getItem('musicStarted') === 'true' && bgMusic.paused) {
            bgMusic.play().catch(err => console.log('Nie moÅ¼na wznowiÄ‡ muzyki'));
        }

        // Uruchom po pierwszym klikniÄ™ciu
        if (sessionStorage.getItem('musicStarted') !== 'true') {
            window.addEventListener('load', function () {
                document.body.addEventListener('click', function startMusic() {
                    bgMusic.play()
                        .then(() => {
                            sessionStorage.setItem('musicStarted', 'true');
                            console.log('Muzyka wystartowaÅ‚a');
                        })
                        .catch(err => console.log('Muzyka zablokowana'));
                }, { once: true });
            });
        }
    </script>
    <!-- DICE ROLLER SIDEBAR -->
    <div class="roller-sidebar" id="rollerSidebar">
        <button class="sidebar-close" onclick="toggleRoller()">âœ•</button>
        {% if 'cthulhu' in request.path %}
        <iframe src="{{ url_for('roller_embedded_cthulhu') }}" class="roller-iframe"></iframe>
        {% else %}
        <iframe src="{{ url_for('roller_embedded') }}" class="roller-iframe"></iframe>
        {% endif %}
    </div>

    <!-- PRZYCISK TOGGLE -->
    <button class="roller-toggle" onclick="toggleRoller()">ğŸ² Roller</button>
</body>

</html>